name: ðŸ”„ Senetic Import Automatico

on:
  schedule:
    # Ogni giorno alle 02:00 UTC (04:00 ora italiana)
    - cron: '0 2 * * *'
  workflow_dispatch: # Permette esecuzione manuale
    inputs:
      force_import:
        description: 'Forza import anche se non ci sono cambiamenti'
        required: false
        default: false
        type: boolean

jobs:
  import-products:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¦ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: 'app-senetic-shopify/package-lock.json'
        
    - name: ðŸ“¥ Install Dependencies
      working-directory: app-senetic-shopify
      run: npm ci
        
    - name: ðŸ”„ Run Senetic Import
      working-directory: app-senetic-shopify
      env:
        SENETIC_AUTH: ${{ secrets.SENETIC_AUTH }}
        SHOPIFY_STORE_URL: ${{ secrets.SHOPIFY_STORE_URL }}
        SHOPIFY_ACCESS_TOKEN: ${{ secrets.SHOPIFY_ACCESS_TOKEN }}
        FORCE_IMPORT: ${{ github.event.inputs.force_import || 'false' }}
        NODE_ENV: production
      run: |
        echo "ðŸ”„ Import automatico avviato"
        echo "ðŸ“Š Force: $FORCE_IMPORT"
        node src/scripts/auto-import.js
        
    - name: ðŸ“Š Upload Import Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: import-results-${{ github.run_number }}
        path: app-senetic-shopify/logs/
        retention-days: 30
        
    - name: ðŸ“Š Display Results Summary
      if: always()
      working-directory: app-senetic-shopify
      run: |
        echo "ðŸ“‹ Risultati import:"
        if [ -f logs/import-*.log ]; then
          echo "ðŸ“„ Log disponibili:"
          ls -la logs/
          echo "ðŸ“– Ultimi 20 righe del log:"
          tail -20 logs/import-*.log
        fi
        if [ -f logs/report-*.json ]; then
          echo "ðŸ“Š Report JSON:"
          cat logs/report-*.json | jq '.summary' || cat logs/report-*.json
        fi